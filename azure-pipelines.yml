# @name: azure-pipelines.yml
# @description: ADO pipeline

#trigger:
#  branches:
#    include:
#      - main
#  paths:
#    include:
#      - changelog.xml

appendCommitMessageToRunName: false
  
name: $(Application.Name)-$(Build.BuildId)-CI

pool:
  name: $(Agent.PoolName)

variables:
- template: variables.yml

stages:
- stage: CI
  displayName: 'Build'
  jobs:
  - job: DB_CI
    displayName: 'Database CI'
    steps:

    - checkout: self

    # this task checks if liquibase is installed on the agent server
    - task: PowerShell@2
      inputs:
        targetType: 'inline'
        script: |
          Write-Host "Checking Liquibase version"
          & "$(L_DIR)\liquibase.bat" --version
      displayName: 'Check Liquibase Version'

    # this task validates that there are errors in liquibase changelog.xml and referenced changesets
    - task: PowerShell@2
      inputs:
        targetType: 'inline'
        script: | 
          $URL = "jdbc:oracle:thin:@//$(Database.Host):$(Database.Port)/$(Database.SID)"
          & "$(L_DIR)\liquibase.bat" `
            --changeLogFile=$(L_CHANGELOG_FILE) `
            --url=$URL `
            --username="$(username)" `
            --password="$(password)" `
            validate
      displayName: 'Validate Changelog'

    # this task states the number of undeployed changesets
    - task: PowerShell@2
      inputs:
        targetType: 'inline'
        script: | 
          $URL = "jdbc:oracle:thin:@//$(Database.Host):$(Database.Port)/$(Database.SID)"
          & "$(L_DIR)\liquibase.bat" `
            --changeLogFile=$(L_CHANGELOG_FILE) `
            --url=$URL `
            --username="$(username)" `
            --password="$(password)" `
            status --verbose
      displayName: 'Show Pending Changesets'

    # this task reviews the SQL statements that will be executed against the database before actually applying them
    - task: PowerShell@2
      inputs:
        targetType: 'inline'
        script: | 
          $URL = "jdbc:oracle:thin:@//$(Database.Host):$(Database.Port)/$(Database.SID)"
          & "$(L_DIR)\liquibase.bat" `
            --changeLogFile=$(L_CHANGELOG_FILE) `
            --url=$URL `
            --username="$(username)" `
            --password="$(password)" `
            updateSql > update-preview.sql
        workingDirectory: $(Build.SourcesDirectory)
      displayName: 'Generate SQL Preview'

    - task: PowerShell@2
      displayName: 'Build Artifact'
      inputs:
        targetType: 'inline'
        script: |
          Copy-Item -Path $(Build.SourcesDirectory)\update-preview.sql -Destination $(Build.ArtifactStagingDirectory)
          Copy-Item -Path $(Build.SourcesDirectory)\scripts -Destination $(Build.ArtifactStagingDirectory) -Recurse

#    - task: ArchiveFiles@2
#      displayName: 'Archive Liquibase Changelogs'
#      inputs:
#        rootFolderOrFile: '$(Build.SourcesDirectory)'
#        includeRootFolder: false
#        archiveType: 'zip'
#        archiveFile: '$(Build.ArtifactStagingDirectory)/liquibase-release.zip'
#        replaceExistingArchive: true

    - task: PublishBuildArtifacts@1
      displayName: 'Publish Artifact'
      inputs:
        PathtoPublish: '$(Build.ArtifactStagingDirectory)'
        ArtifactName: 'db-ci-artifact'
        publishLocation: 'Container'